---
scrape_configs:
  - job_name: prometheus
    scrape_interval: 30s
    honor_labels: true
    static_configs:
      - targets:
          - localhost:9090
{% if prometheus_node_exporter_basic_auth_username is defined %}
  - job_name: node-exporter https
    metrics_path: "/node-exporter/metrics"
    scrape_interval: 30s
    honor_labels: true
    scheme: https
    basic_auth:
      username: {{ prometheus_node_exporter_basic_auth_username }}
      password: {{ prometheus_node_exporter_basic_auth_password }}
    static_configs:
      - targets: {{ prometheus_hosts | map('extract', hostvars) | json_query('[*].nginx_proxies[?exporter!=null && contains(exporter, `node`)].src_hostname') | flatten }}
{% endif %}
{% if prometheus_cadvisor_basic_auth_username is defined %}
  - job_name: cadvisor https
    metrics_path: "/cadvisor/metrics"
    scrape_interval: 30s
    honor_labels: true
    scheme: https
    basic_auth:
      username: {{ prometheus_cadvisor_basic_auth_username }}
      password: {{ prometheus_cadvisor_basic_auth_password }}
    static_configs:
      - targets: {{ prometheus_hosts | map('extract', hostvars) | json_query('[*].nginx_proxies[?exporter!=null && contains(exporter, `cadvisor`)].src_hostname') | flatten }}
{% endif %}
{% if prometheus_nextcloud_exporter_basic_auth_username is defined %}
  - job_name: nextcloud https
    metrics_path: "/nextcloud-exporter/metrics"
    scrape_interval: 30s
    honor_labels: true
    scheme: https
    basic_auth:
      username: {{ prometheus_nextcloud_exporter_basic_auth_username }}
      password: {{ prometheus_nextcloud_exporter_basic_auth_password }}
    static_configs:
      - targets: {{ prometheus_hosts | map('extract', hostvars) | json_query('[*].nginx_proxies[?exporter!=null && contains(exporter, `nextcloud`)].src_hostname') | flatten }}
{% endif %}
{% if prometheus_bigbluebutton_exporter_basic_auth_username is defined %}
  - job_name: bigbluebutton http
    metrics_path: "/bigbluebutton-exporter/metrics"
    scrape_interval: 30s
    honor_labels: true
    scheme: http
    basic_auth:
      username: {{ prometheus_bigbluebutton_exporter_basic_auth_username }}
      password: {{ prometheus_bigbluebutton_exporter_basic_auth_password }}
    static_configs:
      - targets: {{ prometheus_hosts | map('extract', hostvars) | json_query('[*].nginx_proxies[?exporter!=null && contains(exporter, `bigbluebutton`)].src_hostname') | flatten }}
{% endif %}
{% if prometheus_postgres_exporter_basic_auth_username is defined %}
  - job_name: postgres https
    metrics_path: "/postgres-exporter/metrics"
    scrape_interval: 30s
    honor_labels: true
    scheme: https
    basic_auth:
      username: {{ prometheus_postgres_exporter_basic_auth_username }}
      password: {{ prometheus_postgres_exporter_basic_auth_password }}
    static_configs:
      - targets: {{ prometheus_hosts | map('extract', hostvars) | json_query('[*].nginx_proxies[?exporter!=null && contains(exporter, `postgres`)].src_hostname') | flatten }}
{% endif %}
{% if prometheus_restic_server_basic_auth_username is defined %}
  - job_name: restic-server https
    metrics_path: "/restic-server/metrics"
    scrape_interval: 30s
    honor_labels: true
    scheme: https
    basic_auth:
      username: {{ prometheus_restic_server_basic_auth_username }}
      password: {{ prometheus_restic_server_basic_auth_password }}
    static_configs:
      - targets: {{ prometheus_hosts | map('extract', hostvars) | json_query('[*].nginx_proxies[?exporter!=null && contains(exporter, `restic`)].src_hostname') | flatten }}
{% endif %}
{% if prometheus_mysqld_exporter_basic_auth_username is defined %}
  - job_name: mysqld https
    metrics_path: "/mysqld-exporter/metrics"
    scrape_interval: 30s
    honor_labels: true
    scheme: https
    basic_auth:
      username: {{ prometheus_mysqld_exporter_basic_auth_username }}
      password: {{ prometheus_mysqld_exporter_basic_auth_password }}
    static_configs:
      - targets: {{ prometheus_hosts | map('extract', hostvars) | json_query('[*].nginx_proxies[?exporter!=null && contains(exporter, `mysqld`)].src_hostname') | flatten }}
{% endif %}
  - job_name: odoo https
    metrics_path: "/metrics"
    scrape_interval: 60s
    honor_labels: true
    scheme: https
    basic_auth:
      username: {{ prometheus_odoo_basic_auth_username }}
      password: {{ prometheus_odoo_server_basic_auth_password }}
    static_configs:
      - targets: {{ prometheus_hosts | map('extract', hostvars) | json_query('[*].nginx_proxies[?exporter!=null && contains(exporter, `odoo`)].src_hostname') | flatten }}
{% if blackbox_exporter_hostname is defined %}
  - job_name: blackbox
    metrics_path: "/probe"
    scrape_interval: 60s
    params:
      module: [http_401_unauth]
    static_configs:
      - targets: {{ targets }}
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{ blackbox_exporter_hostname }}:9115
{% endif %}
