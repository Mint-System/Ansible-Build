#!/usr/bin/env bash
set -e

script=$(basename "$0")
version="1.0.1"

help() {
  echo
  echo "$script"
  echo
  echo 'Description: Restore MySQL/MariaDB Docker database.'
  echo "Syntax: $script [-c|-d|-f|-i|help]"
  echo 'Example: $script -c mqysl01 -d moodle -f /tmp/dump.sql'
  echo 'options:'
  echo '  -c    Docker container name. Defaults to '\''mysql'\''.'
  echo '  -d    Name of database. Defaults to filename'
  echo '  -f    Path to sql dump.'
  echo '  -i    Create database.'
  echo "  help  Show $script manual."
  echo
}

if [[ "$1" == 'help' ]]; then
    help
    exit
fi

create='false'
container=mysql

while getopts ':c: :d: :f: :i' opt; do
  case $opt in
    c) container="$OPTARG";;
    d) database="$OPTARG";;
    f) file="$OPTARG";;
    i) create='true';;
    \?) echo "Invalid option -$OPTARG" >&2
    help
    exit 1;;
  esac
done

filename=$(basename -- "$file")
database=${database:="${filename%%.*}"}

[[ -z "$file" ]] && { echo 'Parameter -f|filename is empty.' ; exit 1; }

image=$(docker inspect $container --format='{{.Config.Image}}')

if $create; then
    if [[ "$image" =~ 'mariadb' ]]; then
        echo "Create MariaDB database $database ..."
        echo "CREATE DATABASE $database" | docker exec -i "$container" /bin/bash -c "mysql -p\$MARIADB_ROOT_PASSWORD"
    fi
    if [[ "$image" =~ 'mysql' ]]; then
        echo "Create MySQL database $database ..."
        echo "CREATE DATABASE $database" | docker exec -i "$container" /bin/bash -c "mysql -p\$MYSQL_ROOT_PASSWORD"
    fi
fi

if [[ "$image" =~ 'mariadb' ]]; then
  echo "Restore MariaDB database $database from $file ..."
  cat "$file" | docker exec -i "$container" /bin/bash -c "mysql -u \$MARIADB_USER --password=\$MARIADB_PASSWORD --force $database"
fi
if [[ "$image" =~ 'mysql' ]]; then
  echo "Restore MySQL database $database from $file ..."
  cat "$file" | docker exec -i "$container" /bin/bash -c "mysql -p\$MYSQL_ROOT_PASSWORD $database"
fi

echo 'The Docker MySQL/MariaDB restore has finished.'
