- name: "Copy {{ role_name }} scripts"
  copy:
    src: "{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: +x
  loop:
    - run-cron-job

- name: Gather package facts
  package_facts:
    manager: auto

- name: Fail if package restic is not installed
  fail:
    msg: "Package restic not installed"
  when: "'restic' not in ansible_facts.packages"

- name: Register backup rotation job
  cron:
    name: "Backup rotation job"
    hour: "23"
    minute: "{{ 59 |random(seed=restic_repo) }}"
    job: "restic forget --keep-daily {{ restic_backup_rotation.daily }} \
      --keep-weekly {{ restic_backup_rotation.weekly }} --keep-monthly {{ restic_backup_rotation.monthly }} --prune; \
      write-node-exporter-metric -c 'Backup rotation job' -v $?"
    disabled: "{{ item.disabled | default(false) }}"
