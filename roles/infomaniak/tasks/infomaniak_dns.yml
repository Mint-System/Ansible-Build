---
- name: Set infomaniak DNS present fact for {{ zone_name }}
  ansible.builtin.set_fact:
    infomaniak_dns_present: "{{ infomaniak_dns_present | default([]) + [(record.source if record.source != '' else '.') + '-' + record.type ] }}"
  loop: "{{ current_records }}"
  loop_control:
    loop_var: record

- name: Show DNS present list for {{ zone_name }}
  debug:
    var: infomaniak_dns_present

- name: Create new DNS records for {{ zone_name }}
  ansible.builtin.uri:
    url: "{{ infomaniak_api_url }}{{ zone_name }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ infomaniak_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      source: "{{ record.source if record.source != '' else '.' }}"
      type: "{{ record.type }}"
      target: "{{ record.target }}"
      ttl: "{{ record.ttl | default(3600) }}"
    status_code: [200, 201]
    return_content: true
  register: create_result
  loop: "{{ zone_records }}"
  loop_control:
    loop_var: record
    label: "{{ record.source if record.source != '' else '.' }} ({{ record.type }})"
  when:
    - record.state == 'present'
    - (record.source if record.source != '' else '.') + '-' + record.type not in (infomaniak_dns_present | default([]))

- name: Update existing DNS records for {{ zone_name }}
  ansible.builtin.uri:
    url: "{{ infomaniak_api_url }}{{ zone_name }}/records/{{ existing_record.id }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ infomaniak_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      source: "{{ record.source if record.source != '' else '.' }}"
      type: "{{ record.type }}"
      target: "{{ record.target }}"
      ttl: "{{ record.ttl | default(existing_record.ttl) }}"
    status_code: [200, 201]
    return_content: true
  register: update_result
  vars:
    normalized_source: "{{ record.source if record.source != '' else '.' }}"
    _matched_list: "{{ current_records | selectattr('source', 'equalto', normalized_source) | selectattr('type', 'equalto', record.type) | list }}"
    existing_record: "{{ _matched_list[0] if _matched_list | length > 0 else {} }}"
  loop: "{{ zone_records }}"
  loop_control:
    loop_var: record
    label: "{{ normalized_source }} ({{ record.type }})"
  when:
    - record.state == 'present'
    - _matched_list | length > 0
    - normalized_source + '-' + record.type in (infomaniak_dns_present | default([]))
    - existing_record.target != record.target or (record.ttl is defined and existing_record.ttl != record.ttl)

- name: Delete DNS records for {{ zone_name }}
  ansible.builtin.uri:
    url: "{{ infomaniak_api_url }}{{ zone_name }}/records/{{ existing_record.id }}"
    method: DELETE
    headers:
      Authorization: "Bearer {{ infomaniak_token }}"
    status_code: [200, 204]
    return_content: true
  register: delete_result
  vars:
    normalized_source: "{{ record.source if record.source != '' else '.' }}"
    _matched_list: "{{ current_records | selectattr('source', 'equalto', normalized_source) | selectattr('type', 'equalto', record.type) | list }}"
    existing_record: "{{ _matched_list[0] if _matched_list | length > 0 else {} }}"
  loop: "{{ zone_records }}"
  loop_control:
    loop_var: record
    label: "{{ normalized_source }} ({{ record.type }})"
  when:
    - record.state == 'absent'
    - _matched_list | length > 0
    - normalized_source + '-' + record.type in (infomaniak_dns_present | default([]))
