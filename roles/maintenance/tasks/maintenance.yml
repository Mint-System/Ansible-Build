---
- name: Prune docker images, volumes and containers
  community.docker.docker_prune:
    containers: true
    images: true
    volumes: true
    images_filters:
      dangling: false
  register: prune_docker

- name: Show image space reclaimed
  ansible.builtin.debug:
    msg: Removed {{ prune_docker.images | length }} image layers and reclaimed {{ prune_docker.images_space_reclaimed|filesizeformat }} space.

- name: Cleanup journals
  ansible.builtin.command: journalctl --vacuum-time=10d
  changed_when: false
  register: cleanup_journal

- name: Show journal space reclaimed
  ansible.builtin.debug:
    msg: "{{ cleanup_journal.stderr }}"

- name: Find old files in /var/tmp
  ansible.builtin.find:
    paths: /var/tmp
    age: 7d
    recurse: true
  register: old_files

- name: Remove old directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ old_files.files | selectattr('isdir') | map(attribute='path') | list }}"

- name: Remove old files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ old_files.files | rejectattr('isdir') | map(attribute='path') | list }}"
